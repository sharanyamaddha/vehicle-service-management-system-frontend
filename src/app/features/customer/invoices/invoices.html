<div class="content-card">
  <div class="card-header">
    <h3>History</h3>
  </div>

  <div class="card-body">
    <div *ngIf="isLoading" class="loading-state">
      <div class="spinner"></div>
      <p>Loading your history...</p>
    </div>


    <div *ngIf="!isLoading && historyRequests.length === 0" class="empty-state">
      <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path
          d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
          stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
      </svg>
      <p>No completed service history available.</p>
    </div>


    <div *ngIf="!isLoading && historyRequests.length > 0" class="requests-grid">
      <div class="request-card" *ngFor="let request of historyRequests">
        <div class="request-header">
          <div class="request-id">
            <h4>{{ request.requestNumber }}</h4>
            <p class="request-meta">Request ID: {{ request.id | slice:0:8 }}...</p>
          </div>
          <span class="status-badge status-closed">
            CLOSED
          </span>
        </div>

        <div class="request-details two-col-grid">
          <div class="detail-item">
            <span class="label">Vehicle</span>
            <span class="value">{{ getVehicleName(request.vehicleId) }}</span>
          </div>
          <div class="detail-item">
            <span class="label">Service Type</span>
            <span class="value">{{ request.issue }}</span>
          </div>
          <div class="detail-item">
            <span class="label">Date Completed</span>
            <span class="value">{{ request.updatedAt | date:'mediumDate' }}</span>
          </div>
          <div class="detail-item">
            <span class="label">Technician</span>
            <span class="value">{{ request.technicianName || 'Assigned Tech' }}</span>
          </div>
        </div>

        <div class="request-actions">
          <button class="btn-primary" (click)="openInvoice(request)">
            View Invoice
          </button>
        </div>
      </div>
    </div>
  </div>
</div>


<div class="modal-backdrop" *ngIf="showInvoiceModal && selectedInvoice">
  <div class="modal-content invoice-modal">
    <div class="modal-header">
      <h3>Invoice #{{ selectedInvoice.id }}</h3>
      <button class="close-btn" (click)="closeInvoice()">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="invoice-header">
        <div class="to-details">
          <label>Billed To:</label>
          <p>{{ selectedRequest?.customerName || 'Customer' }}</p>
          <p>{{ selectedVehicleName }}</p>
        </div>
        <div class="date-details">
          <label>Date:</label>
          <p>{{ selectedInvoice.createdAt | date }}</p>
          <label>Status:</label>
          <span class="status-badge" [class.paid]="selectedInvoice.status === 'PAID'">{{ selectedInvoice.status
            }}</span>
        </div>
      </div>


      <h4 class="table-title">Parts / Services</h4>
      <div class="invoice-table-wrapper">
        <table class="invoice-table">
          <thead>
            <tr>
              <th>Description</th>
              <th class="text-right">Qty</th>
              <th class="text-right">Total</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let part of selectedRequest?.usedParts">
              <td>{{ part.partName || 'Part' }}</td>
              <td class="text-right">{{ part.qty || part.quantity }}</td>
              <td class="text-right">{{ (part.price | currency : 'INR') || '-' }}</td>
            </tr>
            <tr>
              <td colspan="2" class="fw-bold">Labor Charges</td>
              <td class="text-right">{{ (selectedInvoice.laborCost || 0) | currency:'INR' }}</td>
            </tr>
          </tbody>
          <tfoot>
            <tr class="total-row">
              <td colspan="2">Grand Total</td>
              <td class="text-right">{{ selectedInvoice.total | currency:'INR' }}</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeInvoice()">Close</button>
      <button class="btn-primary" *ngIf="selectedInvoice.status !== 'PAID'" (click)="payNow()">Pay Now</button>
      <button class="btn-success" *ngIf="selectedInvoice.status === 'PAID'" disabled>Paid</button>
    </div>
  </div>
</div>